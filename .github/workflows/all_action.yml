name: all_action

'on':
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch: # Add a button for manual execution

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }} # More dynamic concurrency group name

jobs:
  UpdateData: # More descriptive job name
    runs-on: windows-latest

    steps:
      - name: Set up Node.js 16
        uses: actions/setup-node@v2
        with:
          node-version: 16

      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.CEMS }}
          fetch-depth: 0

      - name: Set up Python 3.10
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

#      - name: Check pip cache directory
#        run: pip cache dir

      - name: Cache Python dependencies
        uses: actions/cache@v2
        with:
          path: c:\users\runneradmin\appdata\local\pip\cache
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run code
        run: |
          python ./code/craw_data.py
        timeout-minutes: 330 # Timeout after nearly 6 hours
        continue-on-error: true

      - name: Commit and push if there are changes
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git pull --rebase # Pull the latest changes without creating a merge commit
          git add -A
          git commit -m "updated" || echo "No changes to commit"
          git push
